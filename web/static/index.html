<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicons / App icons (premium) -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="mask-icon" href="/static/icons/safari-pinned-tab.svg" color="#10B981">
    <link rel="manifest" href="/static/site.webmanifest">
    <meta name="theme-color" content="#10B981">
    <meta name="description" content="Crate - Batch rename music files with metadata-based templates">
    <title>Crate</title>
    <link rel="stylesheet" href="/static/css/styles.css?v=20260208-1748">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-top">
                <div class="header-title-section">
                    <h1>üéµ Crate</h1>
                    <p class="subtitle">Batch rename your music files with metadata-based templates</p>
                </div>
                <div class="header-actions">
                    <span id="api-status-badge" class="status-badge loading">Connecting...</span>
                    <button id="settings-btn" class="btn-icon" title="Settings" aria-label="Open Settings">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Directory Selector -->
            <section class="file-browser-section">
                <div class="section-header">
                    <h2>üìÅ Select Music Directory</h2>
                    <button id="refresh-btn" class="btn btn-secondary" title="Refresh file list" aria-label="Refresh file list">
                        <span aria-hidden="true">üîÑ</span>
                    </button>
                </div>

                <div class="directory-input-group">
                    <input
                        type="text"
                        id="directory-path"
                        class="directory-input"
                        placeholder="/path/to/your/music/folder"
                        aria-label="Directory path"
                    >
                    <button id="browse-btn" class="btn btn-primary" title="Browse for music directory">Browse</button>
                </div>

                <div id="path-breadcrumb" class="breadcrumb hidden"></div>
            </section>

            <!-- File List -->
            <section id="file-list-section" class="file-list-section hidden">
                <div class="section-header">
                    <h2>üéß MP3 Files</h2>
                    <div class="file-stats">
                        <span id="file-count" class="stat-badge">0 files</span>
                        <span id="mp3-count" class="stat-badge">0 MP3s</span>
                        <span id="filtered-count" class="stat-badge hidden">0 shown</span>
                        <div class="search-control">
                            <label for="file-search-input" class="visually-hidden">Search files</label>
                            <div class="search-input-wrapper">
                                <span class="search-icon" aria-hidden="true">üîç</span>
                                <input
                                    type="text"
                                    id="file-search-input"
                                    class="search-input"
                                    placeholder="Search files, artist, title..."
                                    aria-label="Search files by name, artist, or title"
                                    aria-describedby="search-hint"
                                >
                                <button id="search-clear-btn" class="search-clear-btn hidden" aria-label="Clear search" title="Clear search">
                                    <span aria-hidden="true">‚úï</span>
                                </button>
                            </div>
                            <small id="search-hint" class="visually-hidden">Search filters files by filename, artist, or title</small>
                        </div>
                        <div class="sort-control">
                            <label for="file-sort-select">Sort by:</label>
                            <select id="file-sort-select" class="sort-select">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="modified-desc">Date Modified (Newest)</option>
                                <option value="modified-asc">Date Modified (Oldest)</option>
                                <option value="size-desc">Size (Largest)</option>
                                <option value="size-asc">Size (Smallest)</option>
                                <option value="artist-asc">Artist (A-Z)</option>
                                <option value="artist-desc">Artist (Z-A)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="album-asc">Album (A-Z)</option>
                                <option value="album-desc">Album (Z-A)</option>
                                <option value="year-desc">Year (Newest)</option>
                                <option value="year-asc">Year (Oldest)</option>
                                <option value="duration-asc">Duration (Short to Long)</option>
                                <option value="duration-desc">Duration (Long to Short)</option>
                                <option value="bpm-asc">BPM (Low to High)</option>
                                <option value="bpm-desc">BPM (High to Low)</option>
                                <option value="key-asc">Key (A-Z)</option>
                                <option value="key-desc">Key (Z-A)</option>
                                <option value="track-asc">Track Number</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Metadata Loading Progress (at top, below header) -->
                <div id="metadata-progress" class="metadata-progress hidden" role="status" aria-live="polite">
                    <div class="metadata-progress-content">
                        <div class="metadata-progress-header">
                            <div class="spinner-small"></div>
                            <span id="metadata-progress-text">Loading metadata: 0/0 files (0%) - calculating...</span>
                            <button id="metadata-cancel-btn" class="cancel-btn" aria-label="Cancel metadata loading">‚úï Cancel</button>
                        </div>
                        <div class="metadata-progress-bar-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Metadata loading progress">
                            <div id="metadata-progress-bar" class="metadata-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="metadata-current-file" class="metadata-current-file">
                            Processing: <span id="metadata-current-file-name">‚Äî</span>
                        </div>
                    </div>
                </div>

                <!-- Smart Suggestion Banner -->
                <div id="smart-suggestion-banner" class="smart-suggestion-banner hidden" role="alert" aria-live="polite">
                    <div class="suggestion-icon" aria-hidden="true">üí°</div>
                    <div class="suggestion-content">
                        <div class="suggestion-header">
                            <span class="suggestion-label" id="suggestion-label">Smart Suggestion</span>
                            <span class="suggestion-confidence" id="suggestion-confidence"></span>
                        </div>
                        <div class="suggestion-description" id="suggestion-description"></div>
                        <div class="suggestion-template-preview">
                            <span class="template-label">Recommended:</span>
                            <code class="template-code" id="suggestion-template"></code>
                        </div>
                    </div>
                    <div class="suggestion-actions">
                        <button id="suggestion-use-btn" class="btn btn-primary btn-sm">Use This</button>
                        <button id="suggestion-ignore-btn" class="btn btn-secondary btn-sm">Ignore</button>
                        <button id="suggestion-dismiss-btn" class="btn-icon" aria-label="Dismiss suggestion" title="Dismiss">‚úï</button>
                    </div>
                </div>

                <!-- Task #111: Per-Album Smart Detection Banner -->
                <div id="per-album-banner" class="smart-banner smart-banner-per-album" style="display: none;" role="region" aria-label="Per-album smart detection">
                    <!-- Content will be dynamically generated by showPerAlbumBanner() -->
                </div>

                <!-- Floating Rename Action Bar -->
                <div id="floating-action-bar" class="floating-action-bar hidden" role="region" aria-live="polite">
                    <div class="floating-action-content">
                        <span id="floating-selection-count" class="selection-count">0 files selected</span>
                        <div class="floating-action-buttons">
                            <button id="floating-preview-btn" class="btn btn-primary" title="Preview rename changes">
                                üëÅÔ∏è Preview Rename
                            </button>
                            <button id="floating-rename-btn" class="btn btn-primary btn-accent" title="Rename selected files">
                                ‚úÖ <span id="floating-rename-text">Rename Now</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="file-list-container">
                    <table id="file-list" class="file-table">
                        <thead>
                            <tr>
                                <th class="col-checkbox">
                                    <input type="checkbox" id="select-all" aria-label="Select all files" title="Select all files (Ctrl+A)">
                                </th>
                                <th class="col-artwork" title="Album Cover Art">
                                    Art
                                </th>
                                <th class="col-current sortable" data-sort="name" role="button" aria-sort="none" tabindex="0">
                                    Current Filename <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-preview">
                                    Preview (New Name)
                                </th>
                                <th class="col-artist sortable" data-sort="artist" role="button" aria-sort="none" tabindex="0">
                                    Artist <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-title sortable" data-sort="title" role="button" aria-sort="none" tabindex="0">
                                    Title <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-album sortable" data-sort="album" role="button" aria-sort="none" tabindex="0">
                                    Album <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-year sortable" data-sort="year" role="button" aria-sort="none" tabindex="0">
                                    Year <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-genre sortable" data-sort="genre" role="button" aria-sort="none" tabindex="0">
                                    Genre <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-duration sortable" data-sort="duration" role="button" aria-sort="none" tabindex="0">
                                    Duration <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-bpm sortable" data-sort="bpm" role="button" aria-sort="none" tabindex="0">
                                    BPM <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-key sortable" data-sort="key" role="button" aria-sort="none" tabindex="0">
                                    Key <span class="sort-indicator" aria-hidden="true"></span>
                                </th>
                                <th class="col-source">Source</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list-body">
                            <!-- Files will be inserted here -->
                        </tbody>
                        <tbody id="file-list-skeleton" class="file-list-skeleton hidden">
                            <!-- Skeleton rows during loading -->
                            <tr class="skeleton-row">
                                <td class="col-checkbox"><div class="skeleton-box skeleton-checkbox"></div></td>
                                <td class="col-current"><div class="skeleton-box skeleton-text skeleton-filename"></div></td>
                                <td class="col-preview"><div class="skeleton-box skeleton-text skeleton-preview"></div></td>
                                <td class="col-artist"><div class="skeleton-box skeleton-text skeleton-artist"></div></td>
                                <td class="col-title"><div class="skeleton-box skeleton-text skeleton-title"></div></td>
                                <td class="col-bpm"><div class="skeleton-box skeleton-text skeleton-bpm"></div></td>
                                <td class="col-key"><div class="skeleton-box skeleton-text skeleton-key"></div></td>
                                <td class="col-source"><div class="skeleton-box skeleton-text skeleton-source"></div></td>
                                <td class="col-actions"><div class="skeleton-box skeleton-button"></div></td>
                            </tr>
                            <tr class="skeleton-row">
                                <td class="col-checkbox"><div class="skeleton-box skeleton-checkbox"></div></td>
                                <td class="col-current"><div class="skeleton-box skeleton-text skeleton-filename"></div></td>
                                <td class="col-preview"><div class="skeleton-box skeleton-text skeleton-preview"></div></td>
                                <td class="col-artist"><div class="skeleton-box skeleton-text skeleton-artist"></div></td>
                                <td class="col-title"><div class="skeleton-box skeleton-text skeleton-title"></div></td>
                                <td class="col-bpm"><div class="skeleton-box skeleton-text skeleton-bpm"></div></td>
                                <td class="col-key"><div class="skeleton-box skeleton-text skeleton-key"></div></td>
                                <td class="col-source"><div class="skeleton-box skeleton-text skeleton-source"></div></td>
                                <td class="col-actions"><div class="skeleton-box skeleton-button"></div></td>
                            </tr>
                            <tr class="skeleton-row">
                                <td class="col-checkbox"><div class="skeleton-box skeleton-checkbox"></div></td>
                                <td class="col-current"><div class="skeleton-box skeleton-text skeleton-filename"></div></td>
                                <td class="col-preview"><div class="skeleton-box skeleton-text skeleton-preview"></div></td>
                                <td class="col-artist"><div class="skeleton-box skeleton-text skeleton-artist"></div></td>
                                <td class="col-title"><div class="skeleton-box skeleton-text skeleton-title"></div></td>
                                <td class="col-bpm"><div class="skeleton-box skeleton-text skeleton-bpm"></div></td>
                                <td class="col-key"><div class="skeleton-box skeleton-text skeleton-key"></div></td>
                                <td class="col-source"><div class="skeleton-box skeleton-text skeleton-source"></div></td>
                                <td class="col-actions"><div class="skeleton-box skeleton-button"></div></td>
                            </tr>
                            <tr class="skeleton-row">
                                <td class="col-checkbox"><div class="skeleton-box skeleton-checkbox"></div></td>
                                <td class="col-current"><div class="skeleton-box skeleton-text skeleton-filename"></div></td>
                                <td class="col-preview"><div class="skeleton-box skeleton-text skeleton-preview"></div></td>
                                <td class="col-artist"><div class="skeleton-box skeleton-text skeleton-artist"></div></td>
                                <td class="col-title"><div class="skeleton-box skeleton-text skeleton-title"></div></td>
                                <td class="col-bpm"><div class="skeleton-box skeleton-text skeleton-bpm"></div></td>
                                <td class="col-key"><div class="skeleton-box skeleton-text skeleton-key"></div></td>
                                <td class="col-source"><div class="skeleton-box skeleton-text skeleton-source"></div></td>
                                <td class="col-actions"><div class="skeleton-box skeleton-button"></div></td>
                            </tr>
                            <tr class="skeleton-row">
                                <td class="col-checkbox"><div class="skeleton-box skeleton-checkbox"></div></td>
                                <td class="col-current"><div class="skeleton-box skeleton-text skeleton-filename"></div></td>
                                <td class="col-preview"><div class="skeleton-box skeleton-text skeleton-preview"></div></td>
                                <td class="col-artist"><div class="skeleton-box skeleton-text skeleton-artist"></div></td>
                                <td class="col-title"><div class="skeleton-box skeleton-text skeleton-title"></div></td>
                                <td class="col-bpm"><div class="skeleton-box skeleton-text skeleton-bpm"></div></td>
                                <td class="col-key"><div class="skeleton-box skeleton-text skeleton-key"></div></td>
                                <td class="col-source"><div class="skeleton-box skeleton-text skeleton-source"></div></td>
                                <td class="col-actions"><div class="skeleton-box skeleton-button"></div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="loading-files" class="loading-indicator hidden" role="status" aria-live="polite" aria-label="Loading files">
                    <div class="spinner" aria-hidden="true"></div>
                    <p>Loading files...</p>
                </div>

                <div id="no-files-message" class="empty-state hidden" role="status" aria-live="polite">
                    <div class="empty-state-icon">üéµ</div>
                    <h3 class="empty-state-title">No MP3 Files Found</h3>
                    <p class="empty-state-description">
                        This directory doesn't contain any MP3 files.
                    </p>
                    <p class="empty-state-hint">
                        Try selecting a different folder with music files.
                    </p>
                    <button id="empty-browse-again-btn" class="btn btn-primary">
                        üìÅ Choose Different Folder
                    </button>
                </div>
            </section>

            <!-- Actions Section -->
            <section id="actions-section" class="actions-section hidden">
                <button id="preview-btn" class="btn btn-primary btn-large" disabled title="Preview rename changes (Ctrl+P)">
                    üëÅÔ∏è Preview Rename
                </button>
                <button id="rename-now-btn" class="btn btn-primary btn-large" disabled title="Show rename confirmation dialog">
                    ‚úÖ Rename Now
                </button>
                <button id="settings-btn-bottom" class="btn btn-secondary btn-large" title="Configure application settings">
                    ‚öôÔ∏è Settings
                </button>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>Crate v2.0.0</p>
            <p class="footer-links">
                <a href="/docs" target="_blank">API Docs</a> ‚Ä¢
                <a href="/api/health" target="_blank">Health Check</a> ‚Ä¢
                <button id="shortcuts-hint-btn" class="link-button" type="button" aria-label="Show keyboard shortcuts">Keyboard shortcuts: press ?</button>
            </p>
        </footer>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="false"></div>

    <!-- Preview Rename Modal -->
    <div id="preview-modal" class="modal hidden" role="dialog" aria-labelledby="preview-modal-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="preview-modal-title">üëÅÔ∏è Preview Rename</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>

            <div class="modal-body">
                <!-- Preview Statistics -->
                <div class="preview-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="preview-stat-total">0</span>
                        <span class="stat-label">Total Files</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="preview-stat-rename">0</span>
                        <span class="stat-label">Will Rename</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="preview-stat-skip">0</span>
                        <span class="stat-label">Will Skip</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="preview-stat-errors">0</span>
                        <span class="stat-label">Errors</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="preview-controls">
                    <input type="checkbox" id="preview-select-all" aria-label="Select all files">
                    <label for="preview-select-all">Select All</label>
                    <span class="preview-selection-count" id="preview-selection-count">0 selected</span>
                </div>

                <!-- Preview List -->
                <div class="preview-list-container">
                    <div id="preview-loading" class="loading-indicator hidden" role="status" aria-live="polite" aria-label="Loading preview">
                        <div class="spinner" aria-hidden="true"></div>
                        <p>Loading preview...</p>
                        <button id="preview-cancel-btn" class="btn-secondary" style="margin-top: 10px;">Cancel</button>
                    </div>

                    <div id="preview-list" class="preview-list"></div>

                    <div id="preview-empty" class="empty-state hidden">
                        <div class="empty-state-icon">‚ÑπÔ∏è</div>
                        <h3 class="empty-state-title">All Files Keep Current Names</h3>
                        <p class="empty-state-description">
                            All selected files already match the template pattern.
                        </p>
                        <p class="empty-state-hint">
                            Try adjusting your template or selecting different files.
                        </p>
                        <button id="preview-empty-close-btn" class="btn btn-secondary">
                            Close Preview
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="preview-execute-btn" class="btn btn-primary" disabled>
                    ‚úÖ Rename Selected Files
                </button>
                <button id="preview-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Progress Overlay Modal -->
    <div id="progress-overlay" class="progress-overlay hidden">
        <div class="progress-modal">
            <h3 id="progress-title">Renaming Files...</h3>
            <div class="progress-stats-grid">
                <div class="progress-stat">
                    <div class="progress-stat-value" id="progress-percent">0%</div>
                    <div class="progress-stat-label">Complete</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="progress-current">0</div>
                    <div class="progress-stat-label">Processed</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-value" id="progress-total">0</div>
                    <div class="progress-stat-label">Total</div>
                </div>
            </div>

            <div class="progress-bar-wrapper">
                <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
            </div>

            <div class="progress-output" id="progress-output"></div>

            <div id="progress-message" class="progress-message"></div>

            <div class="progress-actions">
                <button id="progress-cancel-btn" class="btn btn-danger">
                    Cancel Operation
                </button>
                <button id="progress-done-btn" class="btn btn-primary hidden">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Now Confirmation Modal -->
    <div id="rename-confirm-modal" class="modal hidden" role="dialog" aria-labelledby="rename-confirm-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rename-confirm-title">‚ö†Ô∏è Confirm Rename Operation</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>

            <div class="modal-body">
                <p class="confirm-message">
                    You are about to rename <strong id="rename-file-count">0</strong> MP3 file(s).
                </p>
                <p class="confirm-warning">
                    This operation will:
                </p>
                <ul class="confirm-details">
                    <li>Rename files based on their ID3 metadata</li>
                    <li>Keep files in their current subdirectories (no moving)</li>
                    <li>Skip files that already have the correct name</li>
                    <li>Show progress in real-time</li>
                </ul>
                <p class="confirm-note">
                    <strong>Note:</strong> You can cancel the operation at any time.
                </p>
            </div>

            <div class="modal-footer">
                <button id="rename-confirm-preview-btn" class="btn btn-secondary">
                    üëÅÔ∏è Show Preview First
                </button>
                <button id="rename-confirm-execute-btn" class="btn btn-primary">
                    ‚úÖ Rename Now
                </button>
                <button id="rename-confirm-cancel-btn" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden" role="dialog" aria-labelledby="settings-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="settings-title">‚öôÔ∏è Settings</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>

            <div class="modal-body">
                <form id="settings-form">
                    <!-- API Keys Section -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üîë API Keys</h3>
                        <div class="settings-description">
                            Configure external service API keys for enhanced metadata lookup.
                        </div>

                        <div class="form-group">
                            <label for="acoustid-api-key">
                                AcoustID API Key
                                <span class="label-hint">(for MusicBrainz audio fingerprinting)</span>
                            </label>
                            <input
                                type="text"
                                id="acoustid-api-key"
                                name="acoustid_api_key"
                                class="form-control"
                                placeholder="Enter your AcoustID API key"
                                aria-describedby="acoustid-help"
                            >
                            <small id="acoustid-help" class="form-help">
                                Get a free API key at <a href="https://acoustid.org/api-key" target="_blank">acoustid.org/api-key</a>
                            </small>
                        </div>
                    </div>

                    <!-- Metadata Detection Section -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üéµ Metadata Detection</h3>
                        <div class="settings-description">
                            Configure how metadata is detected and enhanced.
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-musicbrainz"
                                    name="enable_musicbrainz"
                                    aria-describedby="enable-musicbrainz-help"
                                >
                                <span>Enable MusicBrainz Lookup</span>
                            </label>
                            <small id="enable-musicbrainz-help" class="form-help">
                                Use AcoustID/MusicBrainz to identify tracks by audio fingerprint
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="auto-detect-bpm"
                                    name="auto_detect_bpm"
                                    aria-describedby="auto-detect-bpm-help"
                                >
                                <span>Auto-detect BPM</span>
                            </label>
                            <small id="auto-detect-bpm-help" class="form-help">
                                Use audio analysis (librosa) to detect BPM if missing
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="auto-detect-key"
                                    name="auto_detect_key"
                                    aria-describedby="auto-detect-key-help"
                                >
                                <span>Auto-detect Key</span>
                            </label>
                            <small id="auto-detect-key-help" class="form-help">
                                Use audio analysis to detect musical key if missing
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="key-display-mode">
                                Key Display
                                <span class="label-hint">(how the Key column is shown)</span>
                            </label>
                            <select id="key-display-mode" name="key_display_mode" class="form-control">
                                <option value="musical">Musical (C, Am, etc.)</option>
                                <option value="camelot">Camelot (8A, 9B, etc.)</option>
                                <option value="both">Both (8A (Am))</option>
                            </select>
                            <small class="form-help">
                                Many DJ tools let you switch between musical and Camelot notation. Choose what‚Äôs easiest to scan.
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="use-mb-for-all-fields"
                                    name="use_mb_for_all_fields"
                                    aria-describedby="use-mb-for-all-fields-help"
                                >
                                <span>Use MusicBrainz for Artist/Title/Album</span>
                            </label>
                            <small id="use-mb-for-all-fields-help" class="form-help">
                                Allow MusicBrainz to correct artist, title, album, and year fields
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="verify-mode"
                                    name="verify_mode"
                                    aria-describedby="verify-mode-help"
                                >
                                <span>Verify Mode (Re-analyze All)</span>
                            </label>
                            <small id="verify-mode-help" class="form-help">
                                Re-analyze files even if they already have metadata (validation mode)
                            </small>
                        </div>
                    </div>

                    <!-- Optional Dependencies -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üß© Optional Dependencies</h3>
                        <div class="settings-description">
                            Enable advanced fingerprint lookup by installing optional system tools.
                        </div>

                        <div class="form-group">
                            <div class="deps-status">
                                <div><strong>Chromaprint (fpcalc):</strong> <span id="deps-fpcalc" class="stat-badge">Checking‚Ä¶</span></div>
                                <div><strong>Homebrew (brew):</strong> <span id="deps-brew" class="stat-badge">Checking‚Ä¶</span></div>
                            </div>
                            <small class="form-help">
                                Chromaprint enables audio fingerprinting lookups. It‚Äôs optional ‚Äî everything else still works without it.
                            </small>
                        </div>

                        <div class="form-group">
                            <button type="button" id="deps-install-chromaprint-btn" class="btn btn-primary" disabled>
                                Install Chromaprint (via Homebrew)
                            </button>
                            <div id="deps-install-output" class="template-preview" style="margin-top:10px;"></div>
                        </div>
                    </div>

                    <!-- Filename Template Section -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üìù Filename Template</h3>
                        <div class="settings-description">
                            Customize the filename format using template variables. Click variable buttons below to insert them.
                        </div>

                        <!-- Preset Templates -->
                        <div class="form-group">
                            <label for="template-preset">
                                Quick Presets (DJ & Album Formats)
                            </label>
                            <select id="template-preset" class="form-control">
                                <option value="">-- Select a preset --</option>
                                <optgroup label="DJ / Single Track Formats">
                                    <option value="{artist} - {title} [{camelot} {bpm}]">Electronic/House: Artist - Title [Key BPM]</option>
                                    <option value="{artist} - {title} ({mix}) [{camelot} {bpm}]">With Mix Version: Artist - Title (Mix) [Key BPM]</option>
                                    <option value="{bpm} {camelot} - {artist} - {title}">BPM First: BPM Key - Artist - Title</option>
                                    <option value="{artist} - {title} [{bpm}]">BPM Only: Artist - Title [BPM]</option>
                                    <option value="{artist} - {title} [{key}]">Key Only: Artist - Title [Key]</option>
                                    <option value="{artist} - {title}">Minimal: Artist - Title</option>
                                    <option value="{artist} - {title} ({year}) [{camelot} {bpm}]">Full Metadata: Artist - Title (Year) [Key BPM]</option>
                                </optgroup>
                                <optgroup label="DJ / Specialized Formats">
                                    <option value="{artist} - {title} [{label}] ({key} {bpm}bpm)">Electronic with Label: Artist - Title [Label] (Key BPM)</option>
                                    <option value="{artist} - {title} [{catalog}]">Techno/Minimal: Artist - Title [Catalog]</option>
                                    <option value="{artist} - {title} [{genre}] [{camelot} {bpm}]">Multi-Genre: Artist - Title [Genre] [Key BPM]</option>
                                    <option value="{artist} - {title} - {mix} ({year})">Radio/Broadcast: Artist - Title - Mix (Year)</option>
                                    <option value="{label} {catalog} - {artist} - {title}">Vinyl/Label Focus: Label Catalog - Artist - Title</option>
                                </optgroup>
                                <optgroup label="Album / Collection Formats">
                                    <option value="{track} - {artist} - {title}">Simple Album: Track - Artist - Title</option>
                                    <option value="{track} {title}">Minimal Album: Track Title</option>
                                    <option value="{artist} - {album} - {track} - {title}">Full Album: Artist - Album - Track - Title</option>
                                    <option value="{track} - {title} [{bpm}]">Album with BPM: Track - Title [BPM]</option>
                                    <option value="{album} - {track} - {artist} - {title}">Album First: Album - Track - Artist - Title</option>
                                </optgroup>
                            </select>
                            <small class="form-help">
                                Select a preset to quickly apply industry-standard DJ or album filename formats
                            </small>
                        </div>

                        <!-- Template Input -->
                        <div class="form-group">
                            <label for="default-template">
                                Custom Template
                            </label>
                            <textarea
                                id="default-template"
                                name="default_template"
                                class="form-control template-input"
                                rows="3"
                                placeholder="{artist} - {title} [{camelot} {bpm}]"
                                aria-describedby="template-help"
                            ></textarea>
                            <div id="template-preview" class="template-preview"></div>
                        </div>

                        <!-- Variable Buttons -->
                        <div class="form-group">
                            <label>Available Variables (Click to Insert)</label>
                            <div class="template-variables">
                                <div class="variable-group">
                                    <div class="variable-group-label">Track Info</div>
                                    <button type="button" class="variable-btn" data-variable="{artist}">üé§ Artist</button>
                                    <button type="button" class="variable-btn" data-variable="{title}">üéµ Title</button>
                                    <button type="button" class="variable-btn" data-variable="{album}">üíø Album</button>
                                    <button type="button" class="variable-btn" data-variable="{mix}">üîÄ Mix</button>
                                    <button type="button" class="variable-btn" data-variable="{mix_paren}">üîÄ Mix (paren)</button>
                                    <button type="button" class="variable-btn" data-variable="{year}">üìÖ Year</button>
                                    <button type="button" class="variable-btn" data-variable="{track}">üî¢ Track #</button>
                                </div>
                                <div class="variable-group">
                                    <div class="variable-group-label">DJ Metadata</div>
                                    <button type="button" class="variable-btn" data-variable="{bpm}">‚ö° BPM</button>
                                    <button type="button" class="variable-btn" data-variable="{key}">üéπ Key</button>
                                    <button type="button" class="variable-btn" data-variable="{camelot}">üê´ Camelot</button>
                                    <button type="button" class="variable-btn" data-variable="{kb}">üéØ Key+BPM</button>
                                    <button type="button" class="variable-btn" data-variable="{genre}">üé∏ Genre</button>
                                </div>
                                <div class="variable-group">
                                    <div class="variable-group-label">Label Info</div>
                                    <button type="button" class="variable-btn" data-variable="{label}">üè∑Ô∏è Label</button>
                                    <button type="button" class="variable-btn" data-variable="{catalog}">üìá Catalog #</button>
                                </div>
                            </div>
                            <small id="template-help" class="form-help">
                                Click any button to insert that variable at cursor position. Combine with text like " - ", " [] ", " () " to create your format.
                            </small>
                        </div>

                        <!-- Variable Reference Guide -->
                        <div class="form-group">
                            <details class="variable-reference">
                                <summary class="variable-reference-toggle">üìñ Complete Variable Reference</summary>
                                <div class="variable-reference-content">
                                    <table class="variable-reference-table">
                                        <thead>
                                            <tr>
                                                <th>Variable</th>
                                                <th>Description</th>
                                                <th>Example</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>{artist}</code></td>
                                                <td>Track artist name</td>
                                                <td>Deadmau5</td>
                                            </tr>
                                            <tr>
                                                <td><code>{title}</code></td>
                                                <td>Track title</td>
                                                <td>Strobe</td>
                                            </tr>
                                            <tr>
                                                <td><code>{album}</code></td>
                                                <td>Album name</td>
                                                <td>For Lack Of A Better Name</td>
                                            </tr>
                                            <tr>
                                                <td><code>{mix}</code></td>
                                                <td>Mix/remix version</td>
                                                <td>Original Mix, Club Mix</td>
                                            </tr>
                                            <tr>
                                                <td><code>{mix_paren}</code></td>
                                                <td>Mix in parentheses (auto-formatted)</td>
                                                <td> (Original Mix), (Club Mix)</td>
                                            </tr>
                                            <tr>
                                                <td><code>{year}</code></td>
                                                <td>Release year</td>
                                                <td>2009</td>
                                            </tr>
                                            <tr>
                                                <td><code>{track}</code></td>
                                                <td>Track number</td>
                                                <td>01, 02</td>
                                            </tr>
                                            <tr>
                                                <td><code>{bpm}</code></td>
                                                <td>Beats per minute (tempo)</td>
                                                <td>128</td>
                                            </tr>
                                            <tr>
                                                <td><code>{key}</code></td>
                                                <td>Musical key (notation)</td>
                                                <td>A minor, C# major</td>
                                            </tr>
                                            <tr>
                                                <td><code>{camelot}</code></td>
                                                <td>Camelot wheel notation</td>
                                                <td>8A, 12B</td>
                                            </tr>
                                            <tr>
                                                <td><code>{kb}</code></td>
                                                <td>Key + BPM combo in brackets (auto-formatted)</td>
                                                <td> [8A 128], [12B 140]</td>
                                            </tr>
                                            <tr>
                                                <td><code>{genre}</code></td>
                                                <td>Music genre</td>
                                                <td>House, Techno</td>
                                            </tr>
                                            <tr>
                                                <td><code>{label}</code></td>
                                                <td>Record label</td>
                                                <td>Defected Records</td>
                                            </tr>
                                            <tr>
                                                <td><code>{catalog}</code></td>
                                                <td>Catalog number</td>
                                                <td>DFTD001</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="variable-reference-note">
                                        <strong>üí° Tip:</strong> Not all variables will be available for every track.
                                        Missing metadata will be detected from ID3 tags, MusicBrainz, or audio analysis.
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- Other Options Section -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üîß Other Options</h3>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-smart-detection"
                                    name="enable_smart_detection"
                                    aria-describedby="enable-smart-detection-help"
                                >
                                <span>Enable Smart Track Detection (Beta)</span>
                            </label>
                            <small id="enable-smart-detection-help" class="form-help">
                                Automatically suggests album vs single track templates based on metadata.
                                You can always override suggestions. Off by default.
                            </small>
                        </div>

                        <!-- Task #108: Per-Album Smart Detection -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-per-album-detection"
                                    name="enable_per_album_detection"
                                    aria-describedby="enable-per-album-detection-help"
                                >
                                <span>Enable Per-Album Detection (Experimental)</span>
                            </label>
                            <small id="enable-per-album-detection-help" class="form-help">
                                When loading directories with multiple albums, show individual templates
                                per album for precise control. Requires Smart Track Detection enabled. Off by default.
                            </small>
                        </div>

                        <!-- Task #1: Auto-Apply Feature Flags -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-auto-apply"
                                    name="enable_auto_apply"
                                    checked
                                    aria-describedby="enable-auto-apply-help"
                                >
                                <span>Enable Auto-Apply for High Confidence</span>
                            </label>
                            <small id="enable-auto-apply-help" class="form-help">
                                Automatically apply template when confidence is high (‚â•threshold).
                                If disabled, you'll always review suggestions manually.
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-auto-select-albums"
                                    name="enable_auto_select_albums"
                                    checked
                                    aria-describedby="enable-auto-select-albums-help"
                                >
                                <span>Auto-Select High Confidence Albums</span>
                            </label>
                            <small id="enable-auto-select-albums-help" class="form-help">
                                In per-album mode, automatically check albums with high confidence.
                                You can still uncheck before applying.
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="enable-toast-notifications"
                                    name="enable_toast_notifications"
                                    checked
                                    aria-describedby="enable-toast-notifications-help"
                                >
                                <span>Enable Toast Notifications</span>
                            </label>
                            <small id="enable-toast-notifications-help" class="form-help">
                                Show non-intrusive notifications for actions (rename complete, undo available, etc.).
                                If disabled, you'll only see status updates in the main UI.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="confidence-threshold" class="form-label">
                                Confidence Threshold for Auto-Apply
                            </label>
                            <div class="range-input-group">
                                <input
                                    type="range"
                                    id="confidence-threshold"
                                    name="confidence_threshold"
                                    min="0.7"
                                    max="0.95"
                                    step="0.05"
                                    value="0.9"
                                    aria-describedby="confidence-threshold-help"
                                >
                                <span id="confidence-threshold-value" class="range-value">0.90</span>
                            </div>
                            <small id="confidence-threshold-help" class="form-help">
                                Minimum confidence (0.7-0.95) required for auto-apply. Higher = more conservative.
                                Recommended: 0.90 for balanced accuracy.
                            </small>
                        </div>

                        <!-- Task #84: Remember Last Directory -->
                        <div class="setting-item">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="remember-last-directory"
                                    name="remember_last_directory"
                                    checked
                                    aria-describedby="remember-last-directory-help"
                                >
                                <span>Remember Last Directory</span>
                            </label>
                            <small id="remember-last-directory-help" class="form-help">
                                Automatically return to your last browsed directory on startup.
                                If the directory no longer exists, the closest parent folder will be used.
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    id="recursive-default"
                                    name="recursive_default"
                                    aria-describedby="recursive-default-help"
                                >
                                <span>Scan Subdirectories by Default</span>
                            </label>
                            <small id="recursive-default-help" class="form-help">
                                Include subdirectories when loading a directory
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="track-number-padding">
                                Track Number Padding
                                <span class="label-hint">(for album organization)</span>
                            </label>
                            <select
                                id="track-number-padding"
                                name="track_number_padding"
                                class="form-control"
                                aria-describedby="track-number-padding-help"
                            >
                                <option value="0">No padding (1, 2, 3...)</option>
                                <option value="2" selected>2 digits (01, 02, 03...)</option>
                                <option value="3">3 digits (001, 002, 003...)</option>
                            </select>
                            <small id="track-number-padding-help" class="form-help">
                                Zero-pad track numbers in the {track} variable for proper album sorting
                            </small>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button id="settings-save-btn" class="btn btn-primary">
                    üíæ Save Settings
                </button>
                <button id="settings-reset-btn" class="btn btn-secondary">
                    üîÑ Reset to Defaults
                </button>
                <button id="settings-cancel-btn" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- First Run Welcome Dialog -->
    <div id="first-run-modal" class="modal hidden" role="dialog" aria-labelledby="first-run-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="first-run-title">üëã Welcome to Crate!</h2>
            </div>

            <div class="modal-body">
                <div class="welcome-message">
                    <p>Get started by configuring your API keys for enhanced metadata detection.</p>
                    <p class="welcome-note"><strong>Note:</strong> All keys are optional. The app works great without them using ID3 tags and basic analysis!</p>
                </div>

                <form id="first-run-form">
                    <div class="form-group">
                        <label for="first-run-acoustid-key">
                            AcoustID API Key
                            <span class="label-optional">(Optional)</span>
                        </label>
                        <input
                            type="text"
                            id="first-run-acoustid-key"
                            name="acoustid_api_key"
                            class="form-control"
                            placeholder="Enter your AcoustID API key"
                            aria-describedby="first-run-acoustid-help"
                        >
                        <small id="first-run-acoustid-help" class="form-help">
                            üéµ Enables MusicBrainz audio fingerprinting for accurate metadata lookup.<br>
                            Get a free key at <a href="https://acoustid.org/api-key" target="_blank">acoustid.org/api-key</a>
                        </small>
                    </div>

                    <div class="first-run-features">
                        <div class="feature-section">
                            <h4>‚úÖ Works without API keys:</h4>
                            <ul class="feature-list">
                                <li>üè∑Ô∏è <strong>ID3 tag reading</strong> - Embedded metadata</li>
                                <li>‚ö° <strong>BPM detection</strong> - Audio analysis</li>
                                <li>üéπ <strong>Key detection</strong> - Camelot wheel notation</li>
                                <li>üìù <strong>Batch renaming</strong> - Unlimited files</li>
                                <li>üìã <strong>Templates</strong> - Custom organization patterns</li>
                            </ul>
                        </div>

                        <div class="feature-section feature-section-premium">
                            <h4>üöÄ What API keys unlock:</h4>
                            <ul class="feature-list feature-list-premium">
                                <li>üéµ <strong>MusicBrainz lookup</strong> - 40+ million tracks</li>
                                <li>‚ú® <strong>Auto-correction</strong> - Fix mislabeled files</li>
                                <li>üè¢ <strong>Label & catalog</strong> - Professional metadata</li>
                                <li>üîç <strong>Fingerprinting</strong> - Identify unknown tracks</li>
                                <li>üéØ <strong>High confidence</strong> - Trusted music database</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button id="first-run-save-btn" class="btn btn-primary">
                    üíæ Save & Continue
                </button>
                <button id="first-run-skip-btn" class="btn btn-secondary">
                    ‚è≠Ô∏è Skip for Now
                </button>
            </div>
        </div>
    </div>

    <!-- Directory Browser Modal -->
    <div id="directory-browser-modal" class="modal hidden" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">üìÅ Browse Directories</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>

            <div class="modal-body">
                <!-- Breadcrumb Navigation -->
                <div class="browser-breadcrumb">
                    <button class="breadcrumb-home" title="Go to home directory" aria-label="Go to home directory"><span aria-hidden="true">üè†</span></button>
                    <span class="breadcrumb-separator">/</span>
                    <div id="breadcrumb-parts" class="breadcrumb-parts"></div>
                </div>

                <!-- Sort Controls -->
                <div class="browser-controls">
                    <label for="browser-sort-select" class="browser-sort-label">Sort by:</label>
                    <select id="browser-sort-select" class="browser-sort-select">
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                    </select>
                </div>

                <!-- Directory List -->
                <div class="browser-list-container">
                    <div id="browser-loading" class="browser-loading hidden">
                        <div class="spinner"></div>
                        <p>Loading directories...</p>
                    </div>

                    <div id="browser-list" class="browser-list"></div>

                    <div id="browser-empty" class="browser-empty hidden">
                        <p>üìÇ No subdirectories found</p>
                    </div>
                </div>

                <!-- Current Path Display -->
                <div class="browser-current-path">
                    <label for="browser-path-display">Selected:</label>
                    <input
                        type="text"
                        id="browser-path-display"
                        class="browser-path-display"
                        readonly
                        aria-label="Currently selected path"
                    >
                </div>
            </div>

            <div class="modal-footer">
                <button id="browser-select-btn" class="btn btn-primary">Select Folder</button>
                <button id="browser-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal hidden" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="shortcuts-title">‚å®Ô∏è Keyboard Shortcuts</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-row"><code>?</code><span>Show this help</span></div>
                    <div class="shortcut-row"><code>Esc</code><span>Close dialogs</span></div>
                    <div class="shortcut-row"><code>Ctrl</code>+<code>A</code><span>Select all files</span></div>
                    <div class="shortcut-row"><code>Ctrl</code>+<code>P</code><span>Preview rename changes</span></div>
                </div>
                <p class="shortcuts-note">Tip: shortcuts work when you‚Äôre not typing in a text field.</p>
            </div>
        </div>
    </div>

    <!-- Chromaprint Install Confirm Modal -->
    <div id="deps-install-modal" class="modal hidden" role="dialog" aria-labelledby="deps-install-title" aria-modal="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="deps-install-title">Install Chromaprint</h2>
                <button class="modal-close" aria-label="Close dialog" title="Close">‚úï</button>
            </div>
            <div class="modal-body">
                <p>
                    This will run:
                </p>
                <p>
                    <code id="deps-install-command">brew install chromaprint</code>
                    <button id="deps-copy-command-btn" class="btn btn-secondary btn-sm" type="button" style="margin-left:8px;">
                        Copy
                    </button>
                </p>
                <p class="confirm-note">
                    You may be prompted for your password by Homebrew.
                </p>
            </div>
            <div class="modal-footer">
                <button id="deps-install-confirm-btn" class="btn btn-primary">Install</button>
                <button id="deps-install-cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container (Task #130) -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <!-- Use ES modules (the JS files use import/export) -->
    <script type="module" src="/static/js/app.js?v=20260208-1748"></script>
</body>
</html>
